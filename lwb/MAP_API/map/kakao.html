<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ë§µ ë³‘ì› ê²€ìƒ‰</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e0f41a4d816847e2c93554533d265199&libraries=services"></script>
    <script type="text/javascript">
        window.onload = function () {
            if (typeof kakao !== "undefined") {
                console.log("ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ");
                kakao.maps.load(initializeMap); // API ë¡œë“œ í›„ ì‹¤í–‰
            } else {
                console.error("ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨!");
            }
        };
    </script>
    <style>
        #map { width: 100%; height: 500px; }
        #hospital-details {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
            display: none; 
            table-layout: fixed;
        }

        #hospital-details th, #hospital-details td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        /* ì»¬ëŸ¼ë³„ ê³ ì • ë„ˆë¹„ ì„¤ì • */
        #hospital-details th:nth-child(1),
        #hospital-details td:nth-child(1) { width: 20%; } /* ë³‘ì›ì´ë¦„ */
        #hospital-details th:nth-child(2),
        #hospital-details td:nth-child(2) { width: 30%; } /* ì£¼ì†Œ */
        #hospital-details th:nth-child(3),
        #hospital-details td:nth-child(3) { width: 15%; } /* ì˜ì‚¬ì´ë¦„ */
        #hospital-details th:nth-child(4),
        #hospital-details td:nth-child(4) { width: 15%; } /* ì „í™”ë²ˆí˜¸ */
        #hospital-details th:nth-child(5),
        #hospital-details td:nth-child(5) { width: 10%; } /* ê±°ë¦¬ */
    </style>
</head>
<body>
    <h2>ë‚´ ìœ„ì¹˜ ê¸°ì¤€ í”¼ë¶€ê³¼ ë³‘ì› ê²€ìƒ‰</h2>
    <button onclick="getUserLocation()">ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>
    <p id="status">ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
    <div id="map"></div>

    <!-- ë³‘ì› ìƒì„¸ ì •ë³´ í‘œì‹œ í…Œì´ë¸” -->
    <table id="hospital-details">
        <tr>
            <th>ë³‘ì›ì´ë¦„</th>
            <th>ì£¼ì†Œ</th>
            <th>ì˜ì‚¬ì´ë¦„</th>
            <th>ì „í™”ë²ˆí˜¸</th>
            <th>ê±°ë¦¬ (km)</th>
        </tr>
        <tr>
            <td id="hospital-name">-</td>
            <td id="hospital-address">-</td>
            <td id="doctor-name">-</td>
            <td id="hospital-phone">-</td>
            <td id="hospital-distance">-</td>
        </tr>
    </table>

    <script>
        let map, userMarker;
        let userLat, userLng;
        let hospitals = [];

        function initializeMap() {
            console.log("ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì™„ë£Œ");

            getUserLocation();
        }

        // SVG ë§ˆì»¤ ì•„ì´ì½˜ ì •ì˜
        function createSVGMarker(color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
                            <path fill="${color}" d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5z"/>
                        </svg>`;

            const blob = new Blob([svg], { type: 'image/svg+xml' });
            return URL.createObjectURL(blob);
        }

        // ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„±
        const userMarkerImage = new kakao.maps.MarkerImage(createSVGMarker("blue"), new kakao.maps.Size(40, 40));
        const redMarkerImage = new kakao.maps.MarkerImage(createSVGMarker("red"), new kakao.maps.Size(40, 40));
        const greenMarkerImage = new kakao.maps.MarkerImage(createSVGMarker("green"), new kakao.maps.Size(40, 40));

        // ë³‘ì› ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateHospitalDetails(name, address, doctor, phone, distance) {
            document.getElementById("hospital-name").textContent = name;
            document.getElementById("hospital-address").textContent = address;
            document.getElementById("doctor-name").textContent = doctor;
            document.getElementById("hospital-phone").textContent = phone;
            document.getElementById("hospital-distance").textContent = `${distance.toFixed(2)} km`;
            document.getElementById("hospital-details").style.display = "table";
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap(lat, lng) {
            console.log("ğŸ—ºï¸ ì§€ë„ ì´ˆê¸°í™” ì¤‘...");
            
            let container = document.getElementById('map');
            let options = { center: new kakao.maps.LatLng(lat, lng), level: 5 };
            
            map = new kakao.maps.Map(container, options);

            userMarker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lng),
                map: map
            });

            console.log("âœ… ì§€ë„ ìƒì„± ì™„ë£Œ");
            geocodeHospitals(lat, lng);
        }

        // ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        let lat = position.coords.latitude;
                        let lng = position.coords.longitude;
                        document.getElementById('status').innerText = `ë‚´ ìœ„ì¹˜: ${lat}, ${lng}`;
                        
                        kakao.maps.load(function() {
                            initMap(lat, lng);
                        });
                    },
                    () => {
                        document.getElementById('status').innerText = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    }
                );
            } else {
                document.getElementById('status').innerText = "ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            }
        }

        // ë³‘ì›ì˜ ì£¼ì†Œë¥¼ ê²€ìƒ‰ í›„ ì§€ë„ì— ë§ˆì»¤ ì¶”ê°€
        function geocodeHospitals(userLat, userLng) {
            let geocoder = new kakao.maps.services.Geocoder();

            hospitals.forEach(hospital => {
                let addressToSearch = hospital.address;

                geocoder.addressSearch(addressToSearch, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        let hospitalLat = parseFloat(result[0].y);
                        let hospitalLng = parseFloat(result[0].x);
                        let distance = calculateDistance(userLat, userLng, hospitalLat, hospitalLng);

                        console.log(`âœ… ${hospital.hospital_name} ì£¼ì†Œ ë³€í™˜ ì„±ê³µ â†’ ${hospitalLat}, ${hospitalLng}`);

                        addHospitalMarker(
                            hospitalLat, 
                            hospitalLng, 
                            hospital.hospital_name, 
                            hospital.address, 
                            hospital.doctor_name, 
                            hospital.number, 
                            hospital.dermatologist,
                            distance
                        );
                    } else {
                        console.warn(`âŒ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${hospital.hospital_name}, ì£¼ì†Œ: ${hospital.address}`);
                    }
                });
            });
        }


        // ë³‘ì› ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
        function addHospitalMarker(lat, lng, name, address, doctor, phone, dermatologist, distance) {
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                console.error(`âŒ ì˜ëª»ëœ ì¢Œí‘œ: ${name}, lat=${lat}, lng=${lng}`);
                return;
            }

            lat = parseFloat(lat);
            lng = parseFloat(lng);

            let markerImage = dermatologist === "Yes" ? redMarkerImage : greenMarkerImage;

            let position = new kakao.maps.LatLng(lat, lng);

            let marker = new kakao.maps.Marker({
                position: position,
                map: map,
                image: markerImage
            });

            let infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;"><b>${name}</b> - ${distance.toFixed(2)} km</div>`
            });

            let isOpen = false;

            kakao.maps.event.addListener(marker, 'click', function () {
                if (isOpen) {
                    infowindow.close();
                } else {
                    infowindow.open(map, marker);
                    updateHospitalDetails(name, address, doctor, phone, distance);
                }
                isOpen = !isOpen;
            });

            console.log(`âœ… ë§ˆì»¤ ì¶”ê°€ ì„±ê³µ: ${name}, ì¢Œí‘œ: (${lat}, ${lng})`);
        }


        // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚°
        function calculateDistance(lat1, lon1, lat2, lon2) {
            function toRad(value) { return value * Math.PI / 180; }
            
            let R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            let dLat = toRad(lat2 - lat1);
            let dLon = toRad(lon2 - lon1);
            
            let a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }


        window.onload = function() {
            fetch('/static/hospital_data.json')
                .then(response => response.json())
                .then(data => {
                    hospitals = data;
                })
                .catch(error => console.error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", error));
        };

    </script>
</body>
</html>
